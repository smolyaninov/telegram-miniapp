<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ¬∑ Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --max-width: 720px;
            --radius: 12px;
            --muted: #a9a9a9;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            font-size: clamp(15px, 1.7vw, 18px);
            background: #0f0f0f;
            color: #fff;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: var(--max-width);
            background: #121212;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
            padding: 20px;
            animation: fadeIn .25s ease-out;
        }

        h1 {
            font-size: clamp(20px, 4.5vw, 28px);
            margin: 0 0 4px;
            line-height: 1.2;
        }

        .sub {
            color: var(--muted);
            margin: 0 0 16px;
            font-size: .95em;
        }

        .section {
            border: 1px solid #242424;
            border-radius: 10px;
            padding: 14px;
            margin: 10px 0 14px;
            background: #151515;
        }

        .section h2 {
            font-size: 1rem;
            margin: 0 0 10px;
            color: #cfcfcf;
        }

        .kv {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 8px 12px;
        }

        .k {
            color: var(--muted);
            word-break: break-word;
        }

        .v {
            word-break: break-word;
        }

        pre.json {
            background: #0e0e0e;
            color: #9cff9c;
            padding: 12px;
            border-radius: 8px;
            max-height: 260px;
            overflow: auto;
            font-size: 12px;
            margin: 8px 0 0;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        button {
            background: #0088cc;
            border: none;
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: clamp(14px, 2.8vw, 16px);
        }

        button.secondary {
            background: #2a2a2a;
        }

        .warn {
            background: #2a1420;
            color: #ff9db1;
            border: 1px solid #662;
            padding: 10px;
            border-radius: 8px;
            margin: 6px 0 12px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h1>
    <p class="sub" id="subtitle">–°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Telegram WebApp.</p>

    <div id="warn" class="warn" style="display:none"></div>

    <div class="section">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (initDataUnsafe.user)</h2>
        <div id="userKV" class="kv"></div>
        <pre id="userJSON" class="json" style="display:none"></pre>
        <div class="row">
            <button id="copyUser" class="secondary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
    </div>

    <div class="section">
        <h2>–ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—É—Å–∫–∞ (initDataUnsafe)</h2>
        <div id="ctxKV" class="kv"></div>
        <pre id="ctxJSON" class="json"></pre>
        <div class="row">
            <button id="copyCtx" class="secondary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</button>
        </div>
    </div>

    <div class="section">
        <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã WebApp</h2>
        <div id="appKV" class="kv"></div>
        <pre id="appJSON" class="json"></pre>
        <div class="row">
            <button id="copyApp" class="secondary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON WebApp</button>
            <button id="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram?.WebApp;

    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–∞ –ü–ö –Ω–µ —É–µ–∑–∂–∞–ª–æ –≤ —Ñ—É–ª–ª—Å–∫—Ä–∏–Ω
    if (tg && (tg.platform === 'ios' || tg.platform === 'android')) tg.expand();

    // –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ ‚Äî –ª—ë–≥–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
    try {
        if (tg?.colorScheme === 'light') {
            document.body.style.background = '#ffffff';
            document.querySelector('.container').style.background = '#f7f7f7';
            document.body.style.color = '#111';
        }
    } catch {
    }

    // helpers
    const $ = s => document.querySelector(s);
    const renderKV = (el, obj) => {
        el.innerHTML = '';
        if (!obj || (typeof obj === 'object' && Object.keys(obj).length === 0)) {
            el.innerHTML = '<div class="k">‚Äî</div><div class="v">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        Object.entries(obj).forEach(([k, v]) => {
            const dvk = document.createElement('div');
            dvk.className = 'k';
            dvk.textContent = k;
            const dvv = document.createElement('div');
            dvv.className = 'v';
            dvv.textContent = (typeof v === 'object') ? JSON.stringify(v) : String(v);
            el.appendChild(dvk);
            el.appendChild(dvv);
        });
    };
    const copy = async (str) => {
        try {
            await navigator.clipboard.writeText(str);
            return true;
        } catch {
            return false;
        }
    };

    // 1) USER
    const user = tg?.initDataUnsafe?.user || null;

    // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ user –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –∫–Ω–æ–ø–∫–∞), –º–æ–∂–Ω–æ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å ?first_name –∏–∑ URL, –µ—Å–ª–∏ —Ç—ã –µ–≥–æ –ø–µ—Ä–µ–¥–∞—ë—à—å
    const urlParams = new URLSearchParams(location.search);
    const fallbackFirst = urlParams.get('first_name') || urlParams.get('user') || null;

    const titleName = user?.first_name || fallbackFirst || '–≥–æ—Å—Ç—å';
    $('#title').textContent = `–ü—Ä–∏–≤–µ—Ç, ${titleName}! üëã`;

    renderKV($('#userKV'), user);
    if (user) {
        $('#userJSON').style.display = 'block';
        $('#userJSON').textContent = JSON.stringify(user, null, 2);
    } else {
        $('#userJSON').style.display = 'none';
    }

    // 2) CONTEXT (initDataUnsafe)
    const ctx = tg?.initDataUnsafe || {};
    renderKV($('#ctxKV'), {
        query_id: ctx.query_id,
        chat_type: ctx.chat_type,
        chat_instance: ctx.chat_instance,
        auth_date: ctx.auth_date,
        start_param: ctx.start_param,
        hash: ctx.hash,
        signature: ctx.signature
    });
    $('#ctxJSON').textContent = JSON.stringify(ctx, null, 2);

    // 3) WEBAPP PARAMS
    const app = {
        version: tg?.version,
        platform: tg?.platform,
        colorScheme: tg?.colorScheme,
        isExpanded: tg?.isExpanded,
        viewportHeight: tg?.viewportHeight,
        viewportStableHeight: tg?.viewportStableHeight,
        headerColor: tg?.headerColor,
        backgroundColor: tg?.backgroundColor,
        themeParams: tg?.themeParams
    };
    renderKV($('#appKV'), app);
    $('#appJSON').textContent = JSON.stringify(app, null, 2);

    // WARN if no context (—á–∞—Å—Ç—ã–π –∫–µ–π—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–µ –∏–∑ –±–æ—Ç–∞)
    if (!ctx || Object.keys(ctx).length === 0) {
        const w = $('#warn');
        w.style.display = 'block';
        w.textContent = '‚ö†Ô∏è initDataUnsafe –ø—É—Å—Ç ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ, Mini App –æ—Ç–∫—Ä—ã—Ç –Ω–µ –∏–∑ —á–∞—Ç–∞ –±–æ—Ç–∞. –ß–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, user) –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
    } else if (!ctx.user) {
        const w = $('#warn');
        w.style.display = 'block';
        w.textContent = '‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ initDataUnsafe –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –∫–Ω–æ–ø–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ —Ñ–æ–ª–±—ç–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–º—è.';
    }

    // COPY buttons
    $('#copyUser').addEventListener('click', async () => {
        const ok = await copy(user ? JSON.stringify(user, null, 2) : '{}');
        $('#copyUser').textContent = ok ? '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        setTimeout(() => $('#copyUser').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 1200);
    });
    $('#copyCtx').addEventListener('click', async () => {
        const ok = await copy(JSON.stringify(ctx || {}, null, 2));
        $('#copyCtx').textContent = ok ? '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        setTimeout(() => $('#copyCtx').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞', 1200);
    });
    $('#copyApp').addEventListener('click', async () => {
        const ok = await copy(JSON.stringify(app || {}, null, 2));
        $('#copyApp').textContent = ok ? '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        setTimeout(() => $('#copyApp').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON WebApp', 1200);
    });

    // CLOSE
    $('#close').addEventListener('click', () => tg?.close?.());
</script>
</body>
</html>
